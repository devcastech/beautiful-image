<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Ok</title>
    </head>
    <body>
        <h2>Optimizador Rust 2025</h2>
        <input type="range" id="quality" min="1" max="100" value="75" />
        <input type="file" id="upload" accept="image/*" />
        <p id="status"></p>
        <img
            id="original"
            style="max-width: 100%; border: 2px solid blue; display: none"
        />
        <img
            id="result"
            style="max-width: 100%; border: 2px solid green; display: none"
        />

        <script type="module">
            import { optimizeImage, ResizeMode } from "./pkg/beautiful_image.js";

            function run() {
                const status = document.getElementById("status");
                const input = document.getElementById("upload");
                const imgResult = document.getElementById("result");
                const imgOriginal = document.getElementById("original");
                const quality = document.getElementById("quality");

                input.addEventListener("change", async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    status.innerText = "Procesando en Rust...";

                    const arrayBuffer = await file.arrayBuffer();
                    const bytes = new Uint8Array(arrayBuffer);

                    try {
                        // LLAMADA A RUST: Reducir a 1000px de ancho
                        const resultadoWebP = optimizeImage(bytes, 1000, parseInt(quality.value), ResizeMode.HighQuality);

                        status.innerText = `¡Éxito! Tamaño original: ${bytes.length} bytes -> WebP: ${resultadoWebP.length} bytes`;

                        // Crear URL para mostrar la imagen
                        const blob = new Blob([resultadoWebP], {
                            type: "image/jpeg",
                        });
                        imgResult.src = URL.createObjectURL(blob);
                        imgResult.style.display = "block";
                        
                        const blobOriginal = new Blob([bytes], {
                            type: "image/jpeg",
                        });
                        imgOriginal.src = URL.createObjectURL(blobOriginal);
                        imgOriginal.style.display = "block";
                        
                    } catch (error) {
                        status.innerText = "Error: " + error;
                        console.error(error);
                    }
                });
            }
            run();
        </script>
    </body>
</html>
